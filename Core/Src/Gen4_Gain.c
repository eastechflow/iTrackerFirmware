#include "stm32l4xx_hal.h"
#include "Sensor.h"

#if 1 // iTracker4

// Voltage at wiper position (gain).
// Array element 0 corresponds to gain 0;
// Only elements 4..251 are used.
#define GAIN_MIN  3    // inclusive
#define GAIN_MAX  251  // inclusive
#define GAIN_MIDPOINT 14  // midpoint by voltage between GAIN_MIN (3) and GAIN_MAX (251) is 14
//#define GAIN_MIDPOINT 16  // midpoint by voltage between GAIN_MIN (4) and GAIN_MAX (251) is 16

// Voltage at wiper position (gain).
static float voltage_at_gain[]={   // note v[0] > v[1]
15.05819312,  // 0
13.44116138,  // 1
12.13300806,  // 2
11.05292487,  // 3 - "highest" voltage used
10.14603027,
9.37374361,
8.708151311,
8.128558609,
7.619297652,
7.168288546,
6.766067909,
6.405116836,
6.079385881,
5.783952794,
5.51477167,
5.268486229,
5.04228889,
4.833813043,
4.641049741,
4.462282599,
4.296036401,
4.141036183,
3.996174367,
3.860484164,
3.733117897,
3.613329197,
3.500458314,
3.393919903,
3.293192822,
3.197811564,
3.107359029,
3.021460384,
2.93977785,
2.862006226,
2.787869057,
2.717115328,
2.649516602,
2.584864537,
2.522968724,
2.463654799,
2.406762786,
2.352145645,
2.299667987,
2.249204945,
2.200641172,
2.153869945,
2.108792382,
2.065316727,
2.023357723,
1.982836048,
1.943677805,
1.905814064,
1.869180455,
1.833716798,
1.799366761,
1.766077565,
1.733799702,
1.702486688,
1.672094836,
1.642583049,
1.613912626,
1.586047097,
1.55895206,
1.532595036,
1.506945338,
1.481973951,
1.457653413,
1.43395772,
1.410862226,
1.388343557,
1.366379527,
1.344949067,
1.324032156,
1.303609753,
1.283663738,
1.264176861,
1.245132686,
1.226515547,
1.208310498,
1.190503278,
1.17308027,
1.156028463,
1.139335421,
1.12298925,
1.10697857,
1.091292487,
1.075920566,
1.06085281,
1.046079633,
1.031591843,
1.01738062,
1.003437495,
0.98975434,
0.976323341,
0.963136991,
0.950188072,
0.937469639,
0.924975011,
0.912697756,
0.900631681,
0.88877082,
0.877109423,
0.865641947,
0.854363049,
0.843267571,
0.832350538,
0.821607148,
0.811032762,
0.800622902,
0.790373238,
0.780279588,
0.770337906,
0.760544281,
0.750894929,
0.741386189,
0.732014514,
0.722776475,
0.713668747,
0.704688111,
0.695831446,
0.687095727,
0.678478024,
0.669975491,
0.661585372,
0.653304988,
0.645131744,
0.637063117,
0.629096658,
0.621229989,
0.6134608,
0.605786846,
0.598205946,
0.590715977,
0.583314876,
0.576000639,
0.568771313,
0.561624998,
0.554559848,
0.547574061,
0.540665887,
0.533833619,
0.527075596,
0.520390196,
0.513775844,
0.507231,
0.500754164,
0.494343875,
0.487998705,
0.481717265,
0.475498195,
0.469340172,
0.463241901,
0.45720212,
0.451219596,
0.445293126,
0.439421531,
0.433603663,
0.427838399,
0.42212464,
0.416461313,
0.410847368,
0.405281778,
0.399763539,
0.394291668,
0.388865204,
0.383483205,
0.378144749,
0.372848935,
0.367594878,
0.362381714,
0.357208593,
0.352074685,
0.346979175,
0.341921264,
0.33690017,
0.331915125,
0.326965375,
0.322050181,
0.31716882,
0.312320577,
0.307504756,
0.302720671,
0.297967646,
0.293245022,
0.288552147,
0.283888384,
0.279253104,
0.274645689,
0.270065534,
0.265512042,
0.260984625,
0.256482705,
0.252005716,
0.247553096,
0.243124296,
0.238718772,
0.234335992,
0.229975428,
0.225636563,
0.221318886,
0.217021891,
0.212745084,
0.208487975,
0.204250079,
0.200030921,
0.19583003,
0.191646942,
0.187481198,
0.183332345,
0.179199936,
0.17508353,
0.170982689,
0.166896981,
0.16282598,
0.158769264,
0.154726415,
0.150697019,
0.146680668,
0.142676956,
0.138685483,
0.134705851,
0.130737667,
0.12678054,
0.122834085,
0.118897917,
0.114971657,
0.111054927,
0.107147353,
0.103248563,
0.099358189,
0.095475863,
0.091601223,
0.087733905,
0.083873552,
0.080019804,
0.076172307,
0.072330706,
0.068494651,
0.06466379,
0.060837774,
0.057016256,
0.05319889,
0.04938533,
0.045575234,
0.041768257,
0.037964058,
0.034162295,
0.030362628,
0.026564716,
0.022768221,
0.018972802,
0.015178121,  // 251   "lowest" voltage used (inclusive)
0.01138384,   // 252
0.007589618,  // 253
0.003795118,  // 254
0};           // 255

#endif  // iTracker4

float Gen4_calc_voltage_at_gain(uint16_t gain)  // gain, a number from 0 to 255, corresponds to wiper position of digital pot
{
	uint8_t index;

	if (gain > 255)
		index = 255;
	else
		index = gain;

	return voltage_at_gain[index];
}


void Gen4_gain_init(BINARY_SEARCH *p)
{

  // Set gain array characteristics for Gen4
  p->sort_order  = SORT_ORDER_HI_TO_LO;  // voltage[0] > voltage[1]
  p->lower_bound = GAIN_MIN;
  p->midpoint    = GAIN_MIDPOINT;
  p->upper_bound = GAIN_MAX;

  p->voltage = Gen4_calc_voltage_at_gain;   // pointer to function

}
