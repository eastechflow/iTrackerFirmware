#include "stm32l4xx_hal.h"
#include "Sensor.h"








#if 0
// From Mark Watson 5-4-2022
//
//I hooked up the signal generator to the circuit and disabled the 12V so there would be now high voltage from the transformer.
//With R19 at 4.42 K I get the following measuring across the first two stages:
//  Gain set in counts     Voltage Gain
//    5                        0.11
//   10                        0.24
//   20                        0.46
//   50                        1.2
//  100                        2.4
//  200                        4.8
//  400                       10.5
//  600                       17.0
//  800                       24.0
// 1000                       29.0

#endif




#if 1


/*
 From Mark Watson 5-5-2022

With the original resistor value for R19 of 6.65K I get:

Gain Set      Voltage Gain Measured
    5             0.08
   10             0.17
   20             0.33
   50             0.82
  100             1.65
  200             3.50
  400             7.4
  600            12.0
  800            17.0
 1000            21.5

Mode: normal x,y analysis
Polynomial degree 3, 10 x,y data pairs.
Correlation coefficient = 0.9999010926282237
Standard error = 0.08249278894978314

Output form: simple list (ordered x^0 to x^n):

 c0 = 5.1689997540988256e-002
 c1 = 1.4295806377304716e-002
 c2 = 1.3193657026931692e-005
 c3 = -5.9945208850845054e-009

f(x) =  c0 + (c1*x) + (c2*x*x) + (c3*x*x*x);


Copyright (c) 2019, P. Lutus -- http://arachnoid.com. All Rights Reserved.

The above formula was used to generate the table below.

*/



// Voltage at wiper position (gain).
#if 0
static float voltage_at_gain[]={  // note v[0] < v[1]
		0.052,
		0.066,
		0.08,
		0.095,
		0.109,
		0.123,
		0.138,
		0.152,
		0.167,
		0.181,
		0.196,
		0.211,
		0.225,
		0.24,
		0.254,
		0.269,
		0.284,
		0.299,
		0.313,
		0.328,
		0.343,
		0.358,
		0.373,
		0.387,
		0.402,
		0.417,
		0.432,
		0.447,
		0.462,
		0.477,
		0.492,
		0.507,
		0.522,
		0.538,
		0.553,
		0.568,
		0.583,
		0.598,
		0.614,
		0.629,
		0.644,
		0.66,
		0.675,
		0.69,
		0.706,
		0.721,
		0.737,
		0.752,
		0.768,
		0.783,
		0.799,
		0.814,
		0.83,
		0.846,
		0.861,
		0.877,
		0.893,
		0.908,
		0.924,
		0.94,
		0.956,
		0.971,
		0.987,
		1.003,
		1.019,
		1.035,
		1.051,
		1.067,
		1.083,
		1.099,
		1.115,
		1.131,
		1.147,
		1.163,
		1.179,
		1.196,
		1.212,
		1.228,
		1.244,
		1.26,
		1.277,
		1.293,
		1.309,
		1.326,
		1.342,
		1.358,
		1.375,
		1.391,
		1.408,
		1.424,
		1.441,
		1.457,
		1.474,
		1.49,
		1.507,
		1.524,
		1.54,
		1.557,
		1.574,
		1.59,
		1.607,
		1.624,
		1.641,
		1.658,
		1.674,
		1.691,
		1.708,
		1.725,
		1.742,
		1.759,
		1.776,
		1.793,
		1.81,
		1.827,
		1.844,
		1.861,
		1.878,
		1.895,
		1.912,
		1.93,
		1.947,
		1.964,
		1.981,
		1.999,
		2.016,
		2.033,
		2.05,
		2.068,
		2.085,
		2.103,
		2.12,
		2.137,
		2.155,
		2.172,
		2.19,
		2.207,
		2.225,
		2.242,
		2.26,
		2.278,
		2.295,
		2.313,
		2.331,
		2.348,
		2.366,
		2.384,
		2.401,
		2.419,
		2.437,
		2.455,
		2.473,
		2.491,
		2.508,
		2.526,
		2.544,
		2.562,
		2.58,
		2.598,
		2.616,
		2.634,
		2.652,
		2.67,
		2.688,
		2.706,
		2.725,
		2.743,
		2.761,
		2.779,
		2.797,
		2.816,
		2.834,
		2.852,
		2.87,
		2.889,
		2.907,
		2.925,
		2.944,
		2.962,
		2.981,
		2.999,
		3.017,
		3.036,
		3.054,
		3.073,
		3.091,
		3.11,
		3.129,
		3.147,
		3.166,
		3.184,
		3.203,
		3.222,
		3.24,
		3.259,
		3.278,
		3.297,
		3.315,
		3.334,
		3.353,
		3.372,
		3.391,
		3.41,
		3.428,
		3.447,
		3.466,
		3.485,
		3.504,
		3.523,
		3.542,
		3.561,
		3.58,
		3.599,
		3.618,
		3.637,
		3.656,
		3.676,
		3.695,
		3.714,
		3.733,
		3.752,
		3.772,
		3.791,
		3.81,
		3.829,
		3.849,
		3.868,
		3.887,
		3.907,
		3.926,
		3.945,
		3.965,
		3.984,
		4.004,
		4.023,
		4.043,
		4.062,
		4.082,
		4.101,
		4.121,
		4.14,
		4.16,
		4.179,
		4.199,
		4.219,
		4.238,
		4.258,
		4.278,
		4.297,
		4.317,
		4.337,
		4.357,
		4.376,
		4.396,
		4.416,
		4.436,
		4.456,
		4.476,
		4.495,
		4.515,
		4.535,
		4.555,
		4.575,
		4.595,
		4.615,
		4.635,
		4.655,
		4.675,
		4.695,
		4.715,
		4.735,
		4.755,
		4.776,
		4.796,
		4.816,
		4.836,
		4.856,
		4.876,
		4.897,
		4.917,
		4.937,
		4.957,
		4.978,
		4.998,
		5.018,
		5.039,
		5.059,
		5.079,
		5.1,
		5.12,
		5.14,
		5.161,
		5.181,
		5.202,
		5.222,
		5.243,
		5.263,
		5.284,
		5.304,
		5.325,
		5.345,
		5.366,
		5.387,
		5.407,
		5.428,
		5.449,
		5.469,
		5.49,
		5.511,
		5.531,
		5.552,
		5.573,
		5.593,
		5.614,
		5.635,
		5.656,
		5.677,
		5.697,
		5.718,
		5.739,
		5.76,
		5.781,
		5.802,
		5.823,
		5.844,
		5.865,
		5.886,
		5.907,
		5.928,
		5.949,
		5.97,
		5.991,
		6.012,
		6.033,
		6.054,
		6.075,
		6.096,
		6.117,
		6.138,
		6.159,
		6.181,
		6.202,
		6.223,
		6.244,
		6.265,
		6.287,
		6.308,
		6.329,
		6.351,
		6.372,
		6.393,
		6.414,
		6.436,
		6.457,
		6.478,
		6.5,
		6.521,
		6.543,
		6.564,
		6.585,
		6.607,
		6.628,
		6.65,
		6.671,
		6.693,
		6.714,
		6.736,
		6.757,
		6.779,
		6.801,
		6.822,
		6.844,
		6.865,
		6.887,
		6.909,
		6.93,
		6.952,
		6.974,
		6.995,
		7.017,
		7.039,
		7.06,
		7.082,
		7.104,
		7.126,
		7.147,
		7.169,
		7.191,
		7.213,
		7.235,
		7.256,
		7.278,
		7.3,
		7.322,
		7.344,
		7.366,
		7.388,
		7.41,
		7.431,
		7.453,
		7.475,
		7.497,
		7.519,
		7.541,
		7.563,
		7.585,
		7.607,
		7.629,
		7.651,
		7.674,
		7.696,
		7.718,
		7.74,
		7.762,
		7.784,
		7.806,
		7.828,
		7.85,
		7.873,
		7.895,
		7.917,
		7.939,
		7.961,
		7.984,
		8.006,
		8.028,
		8.05,
		8.073,
		8.095,
		8.117,
		8.139,
		8.162,
		8.184,
		8.206,
		8.229,
		8.251,
		8.274,
		8.296,
		8.318,
		8.341,
		8.363,
		8.385,
		8.408,
		8.43,
		8.453,
		8.475,
		8.498,
		8.52,
		8.543,
		8.565,
		8.588,
		8.61,
		8.633,
		8.655,
		8.678,
		8.7,
		8.723,
		8.746,
		8.768,
		8.791,
		8.813,
		8.836,
		8.859,
		8.881,
		8.904,
		8.927,
		8.949,
		8.972,
		8.995,
		9.017,
		9.04,
		9.063,
		9.086,
		9.108,
		9.131,
		9.154,
		9.177,
		9.199,
		9.222,
		9.245,
		9.268,
		9.291,
		9.313,
		9.336,
		9.359,
		9.382,
		9.405,
		9.428,
		9.45,
		9.473,
		9.496,
		9.519,
		9.542,
		9.565,
		9.588,
		9.611,
		9.634,
		9.657,
		9.68,
		9.703,
		9.726,
		9.749,
		9.772,
		9.795,
		9.818,
		9.841,
		9.864,
		9.887,
		9.91,
		9.933,
		9.956,
		9.979,
		10.002,
		10.025,
		10.048,
		10.071,
		10.095,
		10.118,
		10.141,
		10.164,
		10.187,
		10.21,
		10.233,
		10.257,
		10.28,
		10.303,
		10.326,
		10.349,
		10.372,
		10.396,
		10.419,
		10.442,
		10.465,
		10.489,
		10.512,
		10.535,
		10.558,
		10.582,
		10.605,
		10.628,
		10.651,
		10.675,
		10.698,
		10.721,
		10.745,
		10.768,
		10.791,
		10.815,
		10.838,
		10.861,
		10.885,
		10.908,
		10.931,
		10.955,
		10.978,
		11.002,
		11.025,
		11.048,
		11.072,
		11.095,
		11.119,
		11.142,
		11.166,
		11.189,
		11.212,
		11.236,
		11.259,
		11.283,
		11.306,
		11.33,
		11.353,
		11.377,
		11.4,
		11.424,
		11.447,
		11.471,
		11.494,
		11.518,
		11.541,
		11.565,
		11.588,
		11.612,
		11.636,
		11.659,
		11.683,
		11.706,
		11.73,
		11.753,
		11.777,
		11.801,
		11.824,
		11.848,
		11.871,
		11.895,
		11.919,
		11.942,
		11.966,
		11.989,
		12.013,
		12.037,
		12.06,
		12.084,
		12.108,
		12.131,
		12.155,
		12.179,
		12.202,
		12.226,
		12.25,
		12.273,
		12.297,
		12.321,
		12.345,
		12.368,
		12.392,
		12.416,
		12.439,
		12.463,
		12.487,
		12.511,
		12.534,
		12.558,
		12.582,
		12.606,
		12.629,
		12.653,
		12.677,
		12.701,
		12.724,
		12.748,
		12.772,
		12.796,
		12.819,
		12.843,
		12.867,
		12.891,
		12.915,
		12.938,
		12.962,
		12.986,
		13.01,
		13.034,
		13.058,
		13.081,
		13.105,
		13.129,
		13.153,
		13.177,
		13.201,
		13.224,
		13.248,
		13.272,
		13.296,
		13.32,
		13.344,
		13.367,
		13.391,
		13.415,
		13.439,
		13.463,
		13.487,
		13.511,
		13.535,
		13.558,
		13.582,
		13.606,
		13.63,
		13.654,
		13.678,
		13.702,
		13.726,
		13.75,
		13.773,
		13.797,
		13.821,
		13.845,
		13.869,
		13.893,
		13.917,
		13.941,
		13.965,
		13.989,
		14.013,
		14.037,
		14.06,
		14.084,
		14.108,
		14.132,
		14.156,
		14.18,
		14.204,
		14.228,
		14.252,
		14.276,
		14.3,
		14.324,
		14.348,
		14.372,
		14.396,
		14.42,
		14.444,
		14.468,
		14.491,
		14.515,
		14.539,
		14.563,
		14.587,
		14.611,
		14.635,
		14.659,
		14.683,
		14.707,
		14.731,
		14.755,
		14.779,
		14.803,
		14.827,
		14.851,
		14.875,
		14.899,
		14.923,
		14.947,
		14.971,
		14.995,
		15.019,
		15.043,
		15.067,
		15.091,
		15.115,
		15.139,
		15.163,
		15.187,
		15.211,
		15.235,
		15.258,
		15.282,
		15.306,
		15.33,
		15.354,
		15.378,
		15.402,
		15.426,
		15.45,
		15.474,
		15.498,
		15.522,
		15.546,
		15.57,
		15.594,
		15.618,
		15.642,
		15.666,
		15.69,
		15.714,
		15.738,
		15.762,
		15.786,
		15.81,
		15.834,
		15.858,
		15.882,
		15.906,
		15.93,
		15.954,
		15.978,
		16.002,
		16.026,
		16.049,
		16.073,
		16.097,
		16.121,
		16.145,
		16.169,
		16.193,
		16.217,
		16.241,
		16.265,
		16.289,
		16.313,
		16.337,
		16.361,
		16.385,
		16.409,
		16.433,
		16.457,
		16.48,
		16.504,
		16.528,
		16.552,
		16.576,
		16.6,
		16.624,
		16.648,
		16.672,
		16.696,
		16.72,
		16.744,
		16.767,
		16.791,
		16.815,
		16.839,
		16.863,
		16.887,
		16.911,
		16.935,
		16.959,
		16.983,
		17.006,
		17.03,
		17.054,
		17.078,
		17.102,
		17.126,
		17.15,
		17.174,
		17.197,
		17.221,
		17.245,
		17.269,
		17.293,
		17.317,
		17.34,
		17.364,
		17.388,
		17.412,
		17.436,
		17.46,
		17.483,
		17.507,
		17.531,
		17.555,
		17.579,
		17.603,
		17.626,
		17.65,
		17.674,
		17.698,
		17.722,
		17.745,
		17.769,
		17.793,
		17.817,
		17.84,
		17.864,
		17.888,
		17.912,
		17.935,
		17.959,
		17.983,
		18.007,
		18.03,
		18.054,
		18.078,
		18.102,
		18.125,
		18.149,
		18.173,
		18.196,
		18.22,
		18.244,
		18.268,
		18.291,
		18.315,
		18.339,
		18.362,
		18.386,
		18.41,
		18.433,
		18.457,
		18.481,
		18.504,
		18.528,
		18.552,
		18.575,
		18.599,
		18.622,
		18.646,
		18.67,
		18.693,
		18.717,
		18.74,
		18.764,
		18.788,
		18.811,
		18.835,
		18.858,
		18.882,
		18.906,
		18.929,
		18.953,
		18.976,
		19,
		19.023,
		19.047,
		19.07,
		19.094,
		19.117,
		19.141,
		19.164,
		19.188,
		19.211,
		19.235,
		19.258,
		19.282,
		19.305,
		19.329,
		19.352,
		19.376,
		19.399,
		19.422,
		19.446,
		19.469,
		19.493,
		19.516,
		19.539,
		19.563,
		19.586,
		19.61,
		19.633,
		19.656,
		19.68,
		19.703,
		19.726,
		19.75,
		19.773,
		19.796,
		19.82,
		19.843,
		19.866,
		19.89,
		19.913,
		19.936,
		19.96,
		19.983,
		20.006,
		20.029,
		20.053,
		20.076,
		20.099,
		20.122,
		20.145,
		20.169,
		20.192,
		20.215,
		20.238,
		20.261,
		20.285,
		20.308,
		20.331,
		20.354,
		20.377,
		20.4,
		20.424,
		20.447,
		20.47,
		20.493,
		20.516,
		20.539,
		20.562,
		20.585,
		20.608,
		20.631,
		20.654,
		20.677,
		20.7,
		20.724,
		20.747,
		20.77,
		20.793,
		20.816,
		20.839,
		20.861,
		20.884,
		20.907,
		20.93,
		20.953,
		20.976,
		20.999,
		21.022,
		21.045,
		21.068,
		21.091,
		21.114,
		21.137,
		21.159,
		21.182,
		21.205,
		21.228,
		21.251,
		21.274,
		21.296,
		21.319,
		21.342,
		21.365,
		21.388,
		21.41,
		21.433,
		21.456,
		21.478,
		21.501,
		21.524,
		21.547,
		21.569,
		21.592,
		21.615,
		21.637,
		21.66,
		21.683,
		21.705,
		21.728,
		21.751,
		21.773,
		21.796,
		21.818,
		21.841,
		21.863,
		21.886,
		21.909,
		21.931,
		21.954,
		21.976,
		21.999,
		22.021,
		22.044,
		22.066
};
#endif

#endif


/*
 From Mark Watson 5-5-2022

With the original resistor value for R19 of 6.65K I get:

Gain Set      Voltage Gain Measured
    5             0.08
   10             0.17
   20             0.33
   50             0.82
  100             1.65
  200             3.50
  400             7.4
  600            12.0
  800            17.0
 1000            21.5

Mode: normal x,y analysis
Polynomial degree 3, 10 x,y data pairs.
Correlation coefficient = 0.9999010926282237
Standard error = 0.08249278894978314

Output form: simple list (ordered x^0 to x^n):

 c0 = 5.1689997540988256e-002
 c1 = 1.4295806377304716e-002
 c2 = 1.3193657026931692e-005
 c3 = -5.9945208850845054e-009

f(x) =  c0 + (c1*x) + (c2*x*x) + (c3*x*x*x);


Copyright (c) 2019, P. Lutus -- http://arachnoid.com. All Rights Reserved.

The above formula was used to generate the table below.

*/

#define GAIN_MIN         0   // inclusive
#define GAIN_MAX      1023   // inclusive
#define GAIN_MIDPOINT  556   // midpoint by voltage between GAIN_MIN and GAIN_MAX see discussion below

// span = 22.066 - 0.052 = 22.014
// midpoint is 22.066 - (22.014/2) = 22.066 - 11.007 = 11.059
// nearest is 556 at 11.048


float Gen5_calc_voltage_at_gain(uint16_t gain)  // gain, a number from 0 to 1023, corresponds to wiper position of digital pot
{
  float c0 = 5.1689997540988256e-002;
  float c1 = 1.4295806377304716e-002;
  float c2 = 1.3193657026931692e-005;
  float c3 = -5.9945208850845054e-009;
  float x;

  x = (float) gain;

  return c0 + (c1*x) + (c2*x*x) + (c3*x*x*x);
}


void Gen5_gain_init(BINARY_SEARCH *p)
{
  // Set gain array characteristics for Gen5
  p->sort_order  = SORT_ORDER_LO_TO_HI;  // voltage[0] < voltage[1]
  p->lower_bound = GAIN_MIN;
  p->midpoint    = GAIN_MIDPOINT;
  p->upper_bound = GAIN_MAX;

  p->voltage = Gen5_calc_voltage_at_gain;   // pointer to function
}
